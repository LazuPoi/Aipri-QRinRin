<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ãƒ¼ãƒ‡ç®¡ç†ãƒšãƒ¼ã‚¸</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; padding-bottom: 80px;}
        
        /* â–  ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ â–  */
        .tab-nav { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: #eee; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: bold; color: #555; transition: 0.3s; }
        .tab-btn.active { background: #ff6699; color: white; }
        
        /* ãƒšãƒ¼ã‚¸åˆ‡ã‚Šæ›¿ãˆ */
        .page-section { display: none; }
        .page-section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h2 { color: #333; border-bottom: 2px solid #ff99cc; padding-bottom: 5px; margin-top: 0; }
        .container { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, select { margin: 8px 0; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        label { font-size: 0.9em; font-weight: bold; color: #555; display: block; margin-top: 10px; margin-bottom: -5px;}
        
        .badge-req { color: #ff4444; font-size: 0.8em; margin-left: 5px; }

        /* ãƒœã‚¿ãƒ³é¡ */
        .btn-main { padding: 12px; width: 100%; box-sizing: border-box; background-color: #ff6699; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
        .btn-main:hover { background-color: #e64d7f; }
        .btn-sub { background-color: #66ccff; margin-top: 20px; width: 100%; padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; }

        /* â–  ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ç¾¤ â–  */
        .filter-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        
        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚¹ãƒãƒ›ç”¨ï¼šä¸ŠãŒ1ã¤ã€ä¸‹ãŒ4ã¤ï¼‰ */
        .filter-group { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; /* 4åˆ— */
            gap: 5px; 
        }
        .filter-btn { 
            padding: 10px 5px; 
            border: 1px solid #ff99cc; 
            background-color: #fff; 
            color: #ff6699; 
            border-radius: 4px; 
            cursor: pointer; 
            font-weight: bold; 
            font-size: 0.85em; 
            text-align: center;
        }
        .filter-btn:nth-child(1) { grid-column: 1 / 5; } /* 1ã¤ç›®ã¯å…¨å¹… */

        @media (min-width: 600px) {
            .filter-group { display: flex; }
            .filter-btn { flex: 1; }
            .filter-btn:nth-child(1) { grid-column: auto; } 
        }

        .filter-btn.active { background-color: #ff6699; color: white; }
        
        .fav-filter-btn { width: 100%; background: #fff; border: 2px solid #ffd700; color: #d4af37; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .fav-filter-btn.active { background: #ffd700; color: #fff; }

        /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; position: relative; }
        
        .img-container {
            width: 100%; aspect-ratio: 2 / 3; overflow: hidden; border-radius: 4px; margin-bottom: 8px; cursor: zoom-in; background-color: #f0f0f0; position: relative;
        }
        .img-container img { width: 100%; height: 100%; object-fit: cover; }
        
        .multi-icon { position: absolute; bottom: 5px; right: 5px; background: rgba(0,0,0,0.6); color: white; font-size: 0.7em; padding: 2px 6px; border-radius: 10px; pointer-events: none; }

        .tags { font-size: 0.75em; color: #666; line-height: 1.4; flex-grow: 1; }
        .coord-title { font-size: 1.1em; font-weight: bold; color: #333; display: block; margin-bottom: 4px; border-bottom: 1px dashed #ddd; padding-bottom: 2px; }
        .status-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.9em; margin-bottom: 4px; font-weight: bold; }
        .status-comp { background: #e6fffa; color: #00a0a0; border: 1px solid #00a0a0; }
        .status-notcomp { background: #fff5f5; color: #e53e3e; border: 1px solid #e53e3e; }

        .card-actions { display: flex; gap: 5px; margin-top: 8px; }
        .btn-card { flex: 1; padding: 6px; font-size: 0.8em; border: none; border-radius: 4px; cursor: pointer; color: white; }
        .btn-edit { background-color: #ffa500; }
        .btn-delete { background-color: #ccc; color: #333; }
        
        .fav-star { position: absolute; top: 5px; right: 5px; font-size: 24px; color: #ddd; cursor: pointer; text-shadow: 0 1px 2px rgba(0,0,0,0.3); z-index: 5; transition: transform 0.2s; }
        .fav-star:hover { transform: scale(1.2); }
        .fav-star.active { color: #ffd700; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background: #fff; padding: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 8px; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .modal-imgs { display: flex; flex-direction: column; gap: 10px; align-items: center; }
        .modal-imgs img { max-width: 100%; border-radius: 4px; }
        .loading { display: none; color: #ff6699; font-weight: bold; text-align: center; margin-top: 10px; }

    </style>
</head>
<body>

    <nav class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('list')" id="tabBtn-list">ä¸€è¦§</button>
        <button class="tab-btn" onclick="switchTab('register')" id="tabBtn-register">ç™»éŒ²</button>
    </nav>

    <section id="page-list" class="page-section active">
        <h2>æ¤œç´¢ãƒ»ä¸€è¦§</h2>
        <div class="container" style="padding: 10px;">
            <div class="filter-container">
                <button id="favFilterBtn" class="fav-filter-btn" onclick="toggleFavFilter()">
                    â˜… ãŠæ°—ã«å…¥ã‚Šã®ã¿è¡¨ç¤º
                </button>
                <div class="filter-group">
                    <button class="filter-btn active" onclick="setFilterType('all', this)">ã™ã¹ã¦</button>
                    <button class="filter-btn" onclick="setFilterType('ã‚³ãƒ¼ãƒ‡', this)">ã‚³ãƒ¼ãƒ‡</button>
                    <button class="filter-btn" onclick="setFilterType('ãƒ•ãƒ¬ã‚«', this)">ãƒ•ãƒ¬ã‚«</button>
                    <button class="filter-btn" onclick="setFilterType('ãƒãƒ£ãƒ³ã‚¹QR', this)">ãƒãƒ£ãƒ³ã‚¹</button>
                    <button class="filter-btn" onclick="setFilterType('ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰', this)">ã‚»ãƒ¼ãƒ–</button>
                </div>
            </div>
            <input type="text" id="searchInput" placeholder="æ¤œç´¢ (ã‚³ãƒ¼ãƒ‡åã€ãªã¾ãˆã€ãƒ–ãƒ©ãƒ³ãƒ‰ã€å¼¾æ•°)..." oninput="filterImages()">
        </div>
        <div id="gallery" class="gallery"></div>
        <button id="loadMoreBtn" class="btn-sub" onclick="showMoreImages()" style="display:none;">ã‚‚ã£ã¨è¦‹ã‚‹</button>
    </section>

    <section id="page-register" class="page-section">
        <h2>æ–°è¦ç™»éŒ²</h2>
        <div class="container">
            <label>ç”»åƒ (æœ€å¤§4æš) <span class="badge-req">å¿…é ˆ</span></label>
            <input type="file" id="fileInput" accept="image/*" multiple>
            <small style="color:#888;">â€»Ctrlã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠã§ãã¾ã™</small>

            <label>ç¨®é¡ <span class="badge-req">å¿…é ˆ</span></label>
            <select id="typeSelect" onchange="handleTypeChange()">
                <option value="ã‚³ãƒ¼ãƒ‡" selected>ã‚³ãƒ¼ãƒ‡</option>
                <option value="ãƒ•ãƒ¬ã‚«">ãƒ•ãƒ¬ã‚«</option>
                <option value="ãƒãƒ£ãƒ³ã‚¹QR">ãƒãƒ£ãƒ³ã‚¹QR</option>
                <option value="ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰">ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰</option>
            </select>

            <label>ãªã¾ãˆ <span class="badge-req">å¿…é ˆ</span></label>
            <select id="nameSelect">
                <option value="ã‚Šã‚“ã‚Šã‚“">ã‚Šã‚“ã‚Šã‚“</option>
                <option value="ã‚‹ãºã‚‹ã‹ã‚Šã‚">ã‚‹ãºã‚‹ã‹ã‚Šã‚</option>
                <option value="ã‚‰ã‚“ã‚‰ã‚“">ã‚‰ã‚“ã‚‰ã‚“</option>
                <option value="ã‚‹ã‚“ã‚‹ã‚“">ã‚‹ã‚“ã‚‹ã‚“</option>
                <option value="ã‚Œã‚“ã‚Œã‚“">ã‚Œã‚“ã‚Œã‚“</option>
                <option value="ã‚ã‚“ã‚ã‚“">ã‚ã‚“ã‚ã‚“</option>
                <option value="ã‚‹ã¨ã•ãªã‚Šã‚">ã‚‹ã¨ã•ãªã‚Šã‚</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>

            <div id="standardFields">
                <label>ã‚³ãƒ¼ãƒ‡å <span class="badge-req">å¿…é ˆ</span></label>
                <input type="text" id="coordName" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„">

                <label>ãƒ–ãƒ©ãƒ³ãƒ‰å <span class="badge-req">å¿…é ˆ</span></label>
                <select id="brandSelect">
                    <option value="Poppin' Heart">ğŸ’—Poppin' Heart</option>
                    <option value="Miracle Moon">ğŸŒ™Miracle Moon</option>
                    <option value="Flower March">ğŸ€ï¸Flower March</option>
                    <option value="Scarlet Butterfly">ğŸ¦‹Scarlet Butterfly</option>
                    <option value="Rosession">ğŸŒ¹Rosession</option>
                    <option value="RAINBOW CANDY">ğŸ¬RAINBOW CANDY</option>
                    <option value="Bear Bear Bear">ğŸ»Bear Bear Bear</option>
                    <option value="Love My Music">ğŸ¶Love My Music</option>
                    <option value="Prism Stone">ğŸ’›Prism Stone</option>
                    <option value="Crystal Verse">âœ¨Crystal Verse</option>
                    <option value="Princess Ring">ğŸ’Princess Ring</option>
                    <option value="CUTIE CARAT">ğŸ’CUTIE CARAT</option>
                    <option value="Future School">ğŸš€Future School</option>
                    <option value="Pretty Collection">ğŸ’Pretty Collection</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>

                <label>å¼¾æ•° <span class="badge-req">å¿…é ˆ</span></label>
                <select id="seriesSelect">
                    <option value="1ã ã‚“">1ã ã‚“</option>
                    <option value="2ã ã‚“">2ã ã‚“</option>
                    <option value="3ã ã‚“">3ã ã‚“</option>
                    <option value="4ã ã‚“">4ã ã‚“</option>
                    <option value="5ã ã‚“">5ã ã‚“</option>
                    <option value="6ã ã‚“">6ã ã‚“</option>
                    <option value="6ã ã‚“P">6ã ã‚“P</option>
                    <option value="ãƒªãƒ³ã‚°1ã ã‚“">ãƒªãƒ³ã‚°1ã ã‚“</option>
                    <option value="ãƒªãƒ³ã‚°2ã ã‚“">ãƒªãƒ³ã‚°2ã ã‚“</option>
                    <option value="ãƒªãƒ³ã‚°3ã ã‚“">ãƒªãƒ³ã‚°3ã ã‚“</option>
                    <option value="ãƒªãƒ³ã‚°4ã ã‚“">ãƒªãƒ³ã‚°4ã ã‚“</option>
                    <option value="ãƒªãƒ³ã‚°5ã ã‚“">ãƒªãƒ³ã‚°5ã ã‚“</option>
                    <option value="ãƒªãƒ³ã‚°6ã ã‚“">ãƒªãƒ³ã‚°6ã ã‚“</option>
                    <option value="ãã®ä»–">ãã®ä»–</option>
                </select>
            </div>

            <div id="statusField">
                <label>çŠ¶æ³ <span class="badge-req">å¿…é ˆ(ã‚³ãƒ¼ãƒ‡ã®ã¿)</span></label>
                <select id="statusSelect">
                    <option value="æœªã‚³ãƒ³ãƒ—">æœªã‚³ãƒ³ãƒ—</option>
                    <option value="ã‚³ãƒ³ãƒ—">ã‚³ãƒ³ãƒ—</option>
                </select>
            </div>

            <button class="btn-main" onclick="uploadImage()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
            <p id="statusMsg" class="loading">ç”»åƒã‚’å‡¦ç†ä¸­...</p>
        </div>
    </section>

    <div id="imageModal" class="modal" onclick="if(event.target === this) closeModal()">
        <div class="modal-content" style="background:transparent; box-shadow:none; max-width:800px;">
            <span class="modal-close" style="color:white; top:-10px; right:-10px;" onclick="closeModal()">&times;</span>
            <div id="modalImgs" class="modal-imgs"></div>
        </div>
    </div>

    <div id="editModal" class="modal" onclick="if(event.target === this) closeEditModal()">
        <div class="modal-content">
            <span class="modal-close" onclick="closeEditModal()">&times;</span>
            <h3 style="margin-top:0;">æƒ…å ±ã‚’ç·¨é›†</h3>
            
            <input type="hidden" id="editDocId">
            
            <label>ç¨®é¡</label>
            <select id="editType" onchange="handleEditTypeChange()">
                <option value="ã‚³ãƒ¼ãƒ‡">ã‚³ãƒ¼ãƒ‡</option>
                <option value="ãƒ•ãƒ¬ã‚«">ãƒ•ãƒ¬ã‚«</option>
                <option value="ãƒãƒ£ãƒ³ã‚¹QR">ãƒãƒ£ãƒ³ã‚¹QR</option>
                <option value="ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰">ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰</option>
            </select>

            <label>ãªã¾ãˆ</label>
            <select id="editOwner"></select>

            <div id="editStandardFields">
                <label>ã‚³ãƒ¼ãƒ‡å</label>
                <input type="text" id="editName">
                <label>ãƒ–ãƒ©ãƒ³ãƒ‰</label>
                <select id="editBrand"></select>
                <label>å¼¾æ•°</label>
                <select id="editSeries"></select>
            </div>

            <div id="editStatusField">
                <label>çŠ¶æ³</label>
                <select id="editStatus">
                    <option value="æœªã‚³ãƒ³ãƒ—">æœªã‚³ãƒ³ãƒ—</option>
                    <option value="ã‚³ãƒ³ãƒ—">ã‚³ãƒ³ãƒ—</option>
                </select>
            </div>

            <button class="btn-main" onclick="saveEdit()">ä¿å­˜ã™ã‚‹</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // â–¼â–¼â–¼ ã‚ãªãŸã®ã‚­ãƒ¼æƒ…å ± â–¼â–¼â–¼
        const firebaseConfig = {
          apiKey: "AIzaSyD0KuN_xxHp4p36s5jH3QVfpcpVaEWRUEA",
          authDomain: "aipri-qrinrin.firebaseapp.com",
          projectId: "aipri-qrinrin",
          storageBucket: "aipri-qrinrin.firebasestorage.app",
          messagingSenderId: "770009778959",
          appId: "1:770009778959:web:fdb1188463f5bfdecb8c7a",
          measurementId: "G-DQR6RGHTK7"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let allImages = [];
        let filteredImages = [];
        let displayLimit = 5;
        let currentTypeFilter = 'all';
        let isFavFilterOn = false;

        window.onload = () => {
            handleTypeChange();
            // ç·¨é›†ç”¨Optionã®è¤‡è£½
            document.getElementById('editOwner').innerHTML = document.getElementById('nameSelect').innerHTML;
            document.getElementById('editBrand').innerHTML = document.getElementById('brandSelect').innerHTML;
            document.getElementById('editSeries').innerHTML = document.getElementById('seriesSelect').innerHTML;
        };

        window.switchTab = (tabName) => {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`page-${tabName}`).classList.add('active');
            document.getElementById(`tabBtn-${tabName}`).classList.add('active');
        };

        window.handleTypeChange = () => {
            const type = document.getElementById('typeSelect').value;
            const standardFields = document.getElementById('standardFields');
            const statusField = document.getElementById('statusField');

            if (type === 'ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰') {
                standardFields.style.display = 'none';
            } else {
                standardFields.style.display = 'block';
            }
            if (type === 'ã‚³ãƒ¼ãƒ‡') {
                statusField.style.display = 'block';
            } else {
                statusField.style.display = 'none';
            }
        };

        window.uploadImage = async () => {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            const type = document.getElementById('typeSelect').value;
            let coordName = document.getElementById('coordName').value;
            let name = document.getElementById('nameSelect').value;
            let brand = document.getElementById('brandSelect').value;
            let series = document.getElementById('seriesSelect').value;
            let status = document.getElementById('statusSelect').value;

            if (files.length === 0) { alert("ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
            if (files.length > 4) { alert("ç”»åƒã¯æœ€å¤§4æšã¾ã§ã§ã™"); return; }
            
            // å€¤ã®æ­£è¦åŒ–
            if (type === 'ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰') {
                coordName = "ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰";
                brand = "-";
                series = "-";
                // nameã¯ãã®ã¾ã¾ä½¿ã†
                status = "-";
            } else if (type !== 'ã‚³ãƒ¼ãƒ‡') {
                status = "-";
            }

            if (!coordName || !name || !brand || !series) {
                alert("å…¨é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }

            document.getElementById('statusMsg').style.display = 'block';

            try {
                const imageUrls = [];
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const storageRef = ref(storage, 'images/' + new Date().getTime() + '_' + i + '_' + file.name);
                    await uploadBytes(storageRef, file);
                    const url = await getDownloadURL(storageRef);
                    imageUrls.push(url);
                }

                await addDoc(collection(db, "coords"), {
                    images: imageUrls,
                    type: type,
                    coordName: coordName,
                    name: name,
                    brand: brand,
                    series: series,
                    status: status, 
                    createdAt: new Date()
                });

                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                location.reload(); 
            } catch (e) {
                console.error("Error:", e);
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                document.getElementById('statusMsg').style.display = 'none';
            }
        };

        function getFavList() {
            const stored = localStorage.getItem('my_aipri_favs');
            return stored ? JSON.parse(stored) : [];
        }
        window.toggleFav = (id) => {
            let favs = getFavList();
            if (favs.includes(id)) {
                favs = favs.filter(favId => favId !== id);
            } else {
                favs.push(id);
            }
            localStorage.setItem('my_aipri_favs', JSON.stringify(favs));
            renderGallery(); 
        };

        window.setFilterType = (type, btn) => {
            currentTypeFilter = type;
            document.querySelectorAll('.filter-container .filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            displayLimit = 5;
            filterImages();
        };
        window.toggleFavFilter = () => {
            isFavFilterOn = !isFavFilterOn;
            const btn = document.getElementById('favFilterBtn');
            if (isFavFilterOn) btn.classList.add('active');
            else btn.classList.remove('active');
            displayLimit = 5;
            filterImages();
        };

        async function loadImages() {
            const q = query(collection(db, "coords"), orderBy("createdAt", "desc"));
            const querySnapshot = await getDocs(q);
            allImages = [];
            querySnapshot.forEach(docSnap => {
                const data = docSnap.data();
                data.id = docSnap.id;
                if (!data.images) {
                    data.images = [data.imageUrl || data.imageBase64];
                }
                allImages.push(data);
            });
            filterImages();
        }

        window.filterImages = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const favs = getFavList();

            filteredImages = allImages.filter(item => {
                if (isFavFilterOn && !favs.includes(item.id)) return false;
                if (currentTypeFilter !== 'all' && item.type !== currentTypeFilter) return false;

                const textMatch = 
                    item.coordName.toLowerCase().includes(term) || 
                    item.name.includes(term) ||
                    (item.brand || '').includes(term) ||
                    (item.series || '').includes(term);
                
                return textMatch;
            });
            renderGallery();
        };

        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            gallery.innerHTML = "";
            const favs = getFavList();

            const visibleItems = filteredImages.slice(0, displayLimit);

            visibleItems.forEach(item => {
                const card = document.createElement('div');
                card.className = "card";
                
                const thumbSrc = item.images[0];
                const isMulti = item.images.length > 1;
                const isFav = favs.includes(item.id);

                let statusBadge = "";
                if (item.type === 'ã‚³ãƒ¼ãƒ‡' && item.status && item.status !== '-') {
                    const cls = item.status === 'ã‚³ãƒ³ãƒ—' ? 'status-comp' : 'status-notcomp';
                    statusBadge = `<span class="status-badge ${cls}">${item.status}</span>`;
                }
                
                const dataJson = encodeURIComponent(JSON.stringify(item));

                card.innerHTML = `
                    <div class="fav-star ${isFav ? 'active' : ''}" onclick="toggleFav('${item.id}')">â˜…</div>
                    
                    <div class="img-container" onclick="openModal('${dataJson}')">
                        <img src="${thumbSrc}" loading="lazy">
                        ${isMulti ? '<span class="multi-icon">è¤‡æ•°æš</span>' : ''}
                    </div>

                    <div class="tags">
                        <span class="coord-title">${item.coordName}</span>
                        ${statusBadge}<br>
                        ç¨®é¡: ${item.type} / ${item.name}<br>
                        ${item.brand !== '-' ? item.brand : ''} 
                        ${item.series !== '-' ? ' / ' + item.series : ''}
                    </div>

                    <div class="card-actions">
                        <button class="btn-card btn-edit" onclick="openEditModal('${dataJson}')">ç·¨é›†</button>
                        <button class="btn-card btn-delete" onclick="deleteItem('${item.id}')">å‰Šé™¤</button>
                    </div>
                `;
                gallery.appendChild(card);
            });

            if (filteredImages.length > displayLimit) {
                loadMoreBtn.style.display = "block";
                loadMoreBtn.innerText = `ã‚‚ã£ã¨è¦‹ã‚‹ (æ®‹ã‚Š ${filteredImages.length - displayLimit}æš)`;
            } else {
                loadMoreBtn.style.display = "none";
            }
        }

        window.showMoreImages = () => { displayLimit += 10; renderGallery(); };

        window.deleteItem = async (id) => {
            if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            try {
                await deleteDoc(doc(db, "coords", id));
                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
                location.reload();
            } catch (e) {
                console.error(e);
                alert("å‰Šé™¤å¤±æ•—");
            }
        };

        window.openModal = (encodedJson) => {
            const item = JSON.parse(decodeURIComponent(encodedJson));
            const modal = document.getElementById('imageModal');
            const container = document.getElementById('modalImgs');
            container.innerHTML = "";
            item.images.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                container.appendChild(img);
            });
            modal.style.display = "flex";
        };
        window.closeModal = () => { document.getElementById('imageModal').style.display = "none"; };

        window.openEditModal = (encodedJson) => {
            const item = JSON.parse(decodeURIComponent(encodedJson));
            document.getElementById('editDocId').value = item.id;
            document.getElementById('editType').value = item.type;
            document.getElementById('editName').value = item.coordName;
            document.getElementById('editOwner').value = item.name;
            document.getElementById('editBrand').value = item.brand;
            document.getElementById('editSeries').value = item.series;
            document.getElementById('editStatus').value = (item.status && item.status !== '-') ? item.status : "æœªã‚³ãƒ³ãƒ—";

            handleEditTypeChange();
            document.getElementById('editModal').style.display = "flex";
        };
        
        window.closeEditModal = () => { document.getElementById('editModal').style.display = "none"; };

        window.handleEditTypeChange = () => {
            const type = document.getElementById('editType').value;
            const fields = document.getElementById('editStandardFields');
            const status = document.getElementById('editStatusField');

            if (type === 'ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰') fields.style.display = 'none';
            else fields.style.display = 'block';

            if (type === 'ã‚³ãƒ¼ãƒ‡') status.style.display = 'block';
            else status.style.display = 'none';
        };

        window.saveEdit = async () => {
            const id = document.getElementById('editDocId').value;
            const type = document.getElementById('editType').value;
            let coordName = document.getElementById('editName').value;
            let brand = document.getElementById('editBrand').value;
            let series = document.getElementById('editSeries').value;
            const name = document.getElementById('editOwner').value;
            let status = document.getElementById('editStatus').value;

            // ç·¨é›†æ™‚ã‚‚ã€ŒçŠ¶æ³ã€ã®ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨
            if (type === 'ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰') {
                coordName = "ã‚»ãƒ¼ãƒ–ã‚³ãƒ¼ãƒ‰";
                brand = "-"; series = "-"; status = "-";
            } else if (type !== 'ã‚³ãƒ¼ãƒ‡') {
                status = "-";
            }

            try {
                await updateDoc(doc(db, "coords", id), {
                    type, coordName, name, brand, series, status
                });
                alert("æ›´æ–°ã—ã¾ã—ãŸ");
                closeEditModal();
                loadImages(); 
            } catch (e) {
                console.error(e);
                alert("æ›´æ–°ã‚¨ãƒ©ãƒ¼");
            }
        };

        loadImages();
    </script>
</body>
</html>
