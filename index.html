<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コーデ管理ページ</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        h2 { color: #333; border-bottom: 2px solid #ff99cc; padding-bottom: 5px; }
        .container { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, select { margin: 8px 0; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        label { font-size: 0.9em; font-weight: bold; color: #555; display: block; margin-top: 10px; margin-bottom: -5px;}

        /* アップロードボタン */
        .btn-upload { padding: 12px; width: 100%; box-sizing: border-box; background-color: #ff6699; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
        .btn-upload:hover { background-color: #e64d7f; }
        
        /* 削除ボタン（赤） */
        .btn-delete { background-color: #ccc; font-size: 0.8em; padding: 5px; margin-top: 5px; width: 100%; border: none; border-radius: 4px; color: #333; cursor: pointer; }
        .btn-delete:hover { background-color: #ff4444; color: white; }

        /* もっと見るボタン */
        #loadMoreBtn { background-color: #66ccff; margin-top: 20px; width: 100%; padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; display: none; }
        #loadMoreBtn:hover { background-color: #4db8e8; }

        /* フィルターボタン群 */
        .filter-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-btn { flex: 1; padding: 10px; border: 1px solid #ff99cc; background-color: #fff; color: #ff6699; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .filter-btn.active { background-color: #ff6699; color: white; }
        .filter-btn:hover { background-color: #ffe6f0; }
        .filter-btn.active:hover { background-color: #e64d7f; }

        /* ギャラリー（一覧）のデザイン */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* 画像の統一感（2:3比率） */
        .img-container {
            width: 100%;
            aspect-ratio: 2 / 3;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: zoom-in;
            background-color: #f0f0f0;
        }
        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .img-container:hover img { transform: scale(1.05); }

        .tags { font-size: 0.8em; color: #666; line-height: 1.5; flex-grow: 1; }
        .coord-title { font-size: 1.1em; font-weight: bold; color: #333; display: block; margin-bottom: 4px; border-bottom: 1px dashed #ddd; padding-bottom: 2px;}
        .loading { display: none; color: #ff6699; font-weight: bold; text-align: center; margin-top: 10px; }

        /* 拡大表示（モーダル） */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal img { max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <h2>画像アップロード</h2>
    <div class="container">
        <label>画像</label>
        <input type="file" id="fileInput" accept="image/*">
        
        <label>種類</label>
        <select id="typeSelect">
            <option value="コーデ" selected>コーデ</option>
            <option value="フレカ">フレカ</option>
            <option value="チャンスQR">チャンスQR</option>
        </select>

        <label>コーデ名</label>
        <input type="text" id="coordName" placeholder="入力してください">

        <label>なまえ</label>
        <select id="nameSelect">
            <option value="りんりん">りんりん</option>
            <option value="るぺるかりあ">るぺるかりあ</option>
            <option value="らんらん">らんらん</option>
            <option value="るんるん">るんるん</option>
            <option value="れんれん">れんれん</option>
            <option value="ろんろん">ろんろん</option>
            <option value="るとさなりあ">るとさなりあ</option>
            <option value="その他">その他</option>
        </select>

        <label>ブランド名</label>
        <select id="brandSelect">
            <option value="Poppin' Heart">Poppin' Heart</option>
            <option value="Miracle Moon">Miracle Moon</option>
            <option value="Flower March">Flower March</option>
            <option value="Scarlet Butterfly">Scarlet Butterfly</option>
            <option value="Rosession">Rosession</option>
            <option value="RAINBOW CANDY">RAINBOW CANDY</option>
            <option value="Bear Bear Bear">Bear Bear Bear</option>
            <option value="Love My Music">Love My Music</option>
            <option value="Prism Stone">Prism Stone</option>
            <option value="Crystal Verse">Crystal Verse</option>
            <option value="Princess Ring">Princess Ring</option>
            <option value="CUTIE CARAT">CUTIE CARAT</option>
            <option value="Future School">Future School</option>
            <option value="Pretty Collection">Pretty Collection</option>
        </select>

        <label>弾数</label>
        <select id="seriesSelect">
            <option value="1だん">1だん</option>
            <option value="2だん">2だん</option>
            <option value="3だん">3だん</option>
            <option value="4だん">4だん</option>
            <option value="5だん">5だん</option>
            <option value="6だん">6だん</option>
            <option value="6だんP">6だんP</option>
            <option value="リング1だん">リング1だん</option>
            <option value="リング2だん">リング2だん</option>
            <option value="リング3だん">リング3だん</option>
            <option value="リング4だん">リング4だん</option>
            <option value="リング5だん">リング5だん</option>
            <option value="リング6だん">リング6だん</option>
            <option value="その他">その他</option>
        </select>

        <button class="btn-upload" onclick="uploadImage()">アップロード</button>
        <p id="statusMsg" class="loading">処理中...</p>
    </div>

    <h2>検索・一覧</h2>
    <div class="container" style="padding: 10px;">
        <div class="filter-group">
            <button class="filter-btn active" onclick="setFilterType('all', this)">すべて</button>
            <button class="filter-btn" onclick="setFilterType('コーデ', this)">コーデ</button>
            <button class="filter-btn" onclick="setFilterType('フレカ', this)">フレカ</button>
            <button class="filter-btn" onclick="setFilterType('チャンスQR', this)">チャンス</button>
        </div>

        <input type="text" id="searchInput" placeholder="検索 (コーデ名、なまえ、ブランド、弾数)..." oninput="filterImages()">
    </div>

    <div id="gallery" class="gallery"></div>
    
    <button id="loadMoreBtn" onclick="showMoreImages()">もっと見る (+10枚)</button>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img id="modalImg">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // ▼▼▼ あなたのキー情報に書き換えてください ▼▼▼
        const firebaseConfig = {
          apiKey: "AIzaSyD0KuN_xxHp4p36s5jH3QVfpcpVaEWRUEA",
          authDomain: "aipri-qrinrin.firebaseapp.com",
          projectId: "aipri-qrinrin",
          storageBucket: "aipri-qrinrin.firebasestorage.app",
          messagingSenderId: "770009778959",
          appId: "1:770009778959:web:fdb1188463f5bfdecb8c7a",
          measurementId: "G-DQR6RGHTK7"
        };
        // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let allImages = []; // 全データ
        let filteredImages = []; // 検索・フィルタ後のデータ
        let displayLimit = 5; // 現在表示する枚数
        let currentTypeFilter = 'all'; // 現在選択されている種類フィルター

        // ■■ アップロード機能 ■■
        window.uploadImage = async () => {
            const file = document.getElementById('fileInput').files[0];
            const type = document.getElementById('typeSelect').value;
            const coordName = document.getElementById('coordName').value;
            const name = document.getElementById('nameSelect').value;
            const brand = document.getElementById('brandSelect').value;
            const series = document.getElementById('seriesSelect').value;

            // バリデーション：すべて必須
            if (!file || !type || !coordName || !name || !brand || !series) {
                alert("全選択肢を入力してください！");
                return;
            }

            document.getElementById('statusMsg').style.display = 'block';

            try {
                // 1. Storageへ保存
                const storageRef = ref(storage, 'images/' + new Date().getTime() + '_' + file.name);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);

                // 2. Firestoreへ保存
                await addDoc(collection(db, "coords"), {
                    imageUrl: url,
                    type: type,
                    coordName: coordName,
                    name: name,
                    brand: brand,
                    series: series,
                    createdAt: new Date()
                });

                alert("保存しました！");
                location.reload(); 
            } catch (e) {
                console.error("Error:", e);
                alert("エラー: " + e.message);
            } finally {
                document.getElementById('statusMsg').style.display = 'none';
            }
        };

        // ■■ 削除機能 ■■
        window.deleteItem = async (id, imageUrl) => {
            if (!confirm("本当にこの画像を削除しますか？\n（元に戻せません）")) return;

            // 簡易的なローディング表示（ボタンのテキストを変える）
            const btn = event.target;
            btn.innerText = "削除中...";
            btn.disabled = true;

            try {
                await deleteDoc(doc(db, "coords", id));

                const imageRef = ref(storage, imageUrl);
                await deleteObject(imageRef).catch(e => {
                    console.warn("画像削除エラー（無視します）:", e);
                });

                alert("削除しました");
                location.reload();
            } catch (e) {
                console.error("削除エラー:", e);
                alert("削除に失敗しました");
                btn.innerText = "削除";
                btn.disabled = false;
            }
        };

        // ■■ 読み込み機能 ■■
        async function loadImages() {
            try {
                const q = query(collection(db, "coords"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allImages = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    data.id = docSnap.id; 
                    allImages.push(data);
                });
                
                // 初回フィルタ実行
                filterImages();
            } catch (e) {
                console.error("読み込みエラー:", e);
            }
        }

        // ■■ フィルター切り替え機能 ■■
        window.setFilterType = (type, btnElement) => {
            // 状態更新
            currentTypeFilter = type;

            // ボタンの見た目更新
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // 検索実行
            displayLimit = 5; // フィルタ変更時は表示数をリセット
            filterImages();
        };

        // ■■ 検索・フィルタリングロジック ■■
        window.filterImages = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            filteredImages = allImages.filter(item => {
                // 1. 種類ボタンによるフィルタ
                let typeMatch = false;
                if (currentTypeFilter === 'all') {
                    typeMatch = true;
                } else {
                    typeMatch = (item.type === currentTypeFilter);
                }

                // 2. 検索バーによるテキストフィルタ（種類は含めない）
                // 古いデータにbrand/seriesが無い場合の対策として "|| ''" を追加
                const textMatch = 
                    item.coordName.toLowerCase().includes(term) || 
                    item.name.includes(term) ||
                    (item.brand || '').includes(term) ||
                    (item.series || '').includes(term);

                return typeMatch && textMatch;
            });

            renderGallery();
        };

        // ■■ 描画機能 ■■
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            gallery.innerHTML = "";

            const visibleItems = filteredImages.slice(0, displayLimit);

            visibleItems.forEach(item => {
                const card = document.createElement('div');
                card.className = "card";
                
                let imgSrc = item.imageUrl ? item.imageUrl : item.imageBase64;

                // 表示用のデータ整形（古いデータ対策）
                const brandDisp = item.brand ? `ブランド: ${item.brand}<br>` : "";
                const seriesDisp = item.series ? `弾数: ${item.series}<br>` : "";

                card.innerHTML = `
                    <div class="img-container" onclick="openModal('${imgSrc}')">
                        <img src="${imgSrc}" loading="lazy" alt="${item.coordName}">
                    </div>
                    <div class="tags">
                        <span class="coord-title">${item.coordName}</span>
                        なまえ: ${item.name}<br>
                        種類: ${item.type}<br>
                        ${brandDisp}
                        ${seriesDisp}
                    </div>
                    <button class="btn-delete" onclick="deleteItem('${item.id}', '${imgSrc}')">削除</button>
                `;
                gallery.appendChild(card);
            });

            if (filteredImages.length > displayLimit) {
                loadMoreBtn.style.display = "block";
                loadMoreBtn.innerText = `もっと見る (残り ${filteredImages.length - displayLimit}枚)`;
            } else {
                loadMoreBtn.style.display = "none";
            }
        }

        window.showMoreImages = () => {
            displayLimit += 10;
            renderGallery();
        };

        // ■■ モーダル機能 ■■
        window.openModal = (src) => {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            modal.style.display = "flex";
            modalImg.src = src;
        };

        window.closeModal = () => {
            document.getElementById('imageModal').style.display = "none";
        };

        loadImages();
    </script>
</body>
</html>
