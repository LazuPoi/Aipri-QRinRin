<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚³ãƒ¼ãƒ‡ç®¡ç†ãƒšãƒ¼ã‚¸</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; background-color: #f9f9f9; }
        h2 { color: #333; border-bottom: 2px solid #ff99cc; padding-bottom: 5px; }
        .container { background: #fff; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        input, select { margin: 8px 0; padding: 10px; width: 100%; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        label { font-size: 0.9em; font-weight: bold; color: #555; display: block; margin-top: 10px; margin-bottom: -5px;}

        /* ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ */
        .btn-upload { padding: 12px; width: 100%; box-sizing: border-box; background-color: #ff6699; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: background 0.3s; margin-top: 20px; }
        .btn-upload:hover { background-color: #e64d7f; }
        
        /* å‰Šé™¤ãƒœã‚¿ãƒ³ï¼ˆèµ¤ï¼‰ */
        .btn-delete { background-color: #ccc; font-size: 0.8em; padding: 5px; margin-top: 5px; width: 100%; border: none; border-radius: 4px; color: #333; cursor: pointer; }
        .btn-delete:hover { background-color: #ff4444; color: white; }

        /* ã‚‚ã£ã¨è¦‹ã‚‹ãƒœã‚¿ãƒ³ */
        #loadMoreBtn { background-color: #66ccff; margin-top: 20px; width: 100%; padding: 12px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; display: none; }
        #loadMoreBtn:hover { background-color: #4db8e8; }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ç¾¤ */
        .filter-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .filter-btn { flex: 1; padding: 10px; border: 1px solid #ff99cc; background-color: #fff; color: #ff6699; border-radius: 4px; cursor: pointer; font-weight: bold; transition: all 0.2s; }
        .filter-btn.active { background-color: #ff6699; color: white; }
        .filter-btn:hover { background-color: #ffe6f0; }
        .filter-btn.active:hover { background-color: #e64d7f; }

        /* ã‚®ãƒ£ãƒ©ãƒªãƒ¼ï¼ˆä¸€è¦§ï¼‰ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .gallery { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* ç”»åƒã®çµ±ä¸€æ„Ÿï¼ˆ2:3æ¯”ç‡ï¼‰ */
        .img-container {
            width: 100%;
            aspect-ratio: 2 / 3;
            overflow: hidden;
            border-radius: 4px;
            margin-bottom: 8px;
            cursor: zoom-in;
            background-color: #f0f0f0;
        }
        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        .img-container:hover img { transform: scale(1.05); }

        .tags { font-size: 0.8em; color: #666; line-height: 1.5; flex-grow: 1; }
        .coord-title { font-size: 1.1em; font-weight: bold; color: #333; display: block; margin-bottom: 4px; border-bottom: 1px dashed #ddd; padding-bottom: 2px;}
        .loading { display: none; color: #ff6699; font-weight: bold; text-align: center; margin-top: 10px; }

        /* æ‹¡å¤§è¡¨ç¤ºï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal img { max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .modal-close { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

    <h2>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
    <div class="container">
        <label>ç”»åƒ</label>
        <input type="file" id="fileInput" accept="image/*">
        
        <label>ç¨®é¡</label>
        <select id="typeSelect">
            <option value="ã‚³ãƒ¼ãƒ‡" selected>ã‚³ãƒ¼ãƒ‡</option>
            <option value="ãƒ•ãƒ¬ã‚«">ãƒ•ãƒ¬ã‚«</option>
            <option value="ãƒãƒ£ãƒ³ã‚¹QR">ãƒãƒ£ãƒ³ã‚¹QR</option>
        </select>

        <label>ã‚³ãƒ¼ãƒ‡å</label>
        <input type="text" id="coordName" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„">

        <label>ãªã¾ãˆ</label>
        <select id="nameSelect">
            <option value="ã‚Šã‚“ã‚Šã‚“">ã‚Šã‚“ã‚Šã‚“</option>
            <option value="ã‚‹ãºã‚‹ã‹ã‚Šã‚">ã‚‹ãºã‚‹ã‹ã‚Šã‚</option>
            <option value="ã‚‰ã‚“ã‚‰ã‚“">ã‚‰ã‚“ã‚‰ã‚“</option>
            <option value="ã‚‹ã‚“ã‚‹ã‚“">ã‚‹ã‚“ã‚‹ã‚“</option>
            <option value="ã‚Œã‚“ã‚Œã‚“">ã‚Œã‚“ã‚Œã‚“</option>
            <option value="ã‚ã‚“ã‚ã‚“">ã‚ã‚“ã‚ã‚“</option>
            <option value="ã‚‹ã¨ã•ãªã‚Šã‚">ã‚‹ã¨ã•ãªã‚Šã‚</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
        </select>

        <label>ãƒ–ãƒ©ãƒ³ãƒ‰å</label>
        <select id="brandSelect">
            <option value="Poppin' Heart">ğŸ’—Poppin' Heart</option>
            <option value="Miracle Moon">ğŸŒ™Miracle Moon</option>
            <option value="Flower March">ğŸ€ï¸Flower March</option>
            <option value="Scarlet Butterfly">ğŸ¦‹Scarlet Butterfly</option>
            <option value="Rosession">ğŸŒ¹Rosession</option>
            <option value="RAINBOW CANDY">ğŸ¬RAINBOW CANDY</option>
            <option value="Bear Bear Bear">ğŸ»Bear Bear Bear</option>
            <option value="Love My Music">ğŸ¶Love My Music</option>
            <option value="Prism Stone">ğŸ’›Prism Stone</option>
            <option value="Crystal Verse">âœ¨Crystal Verse</option>
            <option value="Princess Ring">ğŸ’Princess Ring</option>
            <option value="CUTIE CARAT">ğŸ’CUTIE CARAT</option>
            <option value="Future School">ğŸš€Future School</option>
            <option value="Pretty Collection">ğŸ’Pretty Collection</option>
        </select>

        <label>å¼¾æ•°</label>
        <select id="seriesSelect">
            <option value="1ã ã‚“">1ã ã‚“</option>
            <option value="2ã ã‚“">2ã ã‚“</option>
            <option value="3ã ã‚“">3ã ã‚“</option>
            <option value="4ã ã‚“">4ã ã‚“</option>
            <option value="5ã ã‚“">5ã ã‚“</option>
            <option value="6ã ã‚“">6ã ã‚“</option>
            <option value="6ã ã‚“P">6ã ã‚“P</option>
            <option value="ãƒªãƒ³ã‚°1ã ã‚“">ãƒªãƒ³ã‚°1ã ã‚“</option>
            <option value="ãƒªãƒ³ã‚°2ã ã‚“">ãƒªãƒ³ã‚°2ã ã‚“</option>
            <option value="ãƒªãƒ³ã‚°3ã ã‚“">ãƒªãƒ³ã‚°3ã ã‚“</option>
            <option value="ãƒªãƒ³ã‚°4ã ã‚“">ãƒªãƒ³ã‚°4ã ã‚“</option>
            <option value="ãƒªãƒ³ã‚°5ã ã‚“">ãƒªãƒ³ã‚°5ã ã‚“</option>
            <option value="ãƒªãƒ³ã‚°6ã ã‚“">ãƒªãƒ³ã‚°6ã ã‚“</option>
            <option value="ãã®ä»–">ãã®ä»–</option>
        </select>

        <button class="btn-upload" onclick="uploadImage()">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <p id="statusMsg" class="loading">å‡¦ç†ä¸­...</p>
    </div>

    <h2>æ¤œç´¢ãƒ»ä¸€è¦§</h2>
    <div class="container" style="padding: 10px;">
        <div class="filter-group">
            <button class="filter-btn active" onclick="setFilterType('all', this)">ã™ã¹ã¦</button>
            <button class="filter-btn" onclick="setFilterType('ã‚³ãƒ¼ãƒ‡', this)">ã‚³ãƒ¼ãƒ‡</button>
            <button class="filter-btn" onclick="setFilterType('ãƒ•ãƒ¬ã‚«', this)">ãƒ•ãƒ¬ã‚«</button>
            <button class="filter-btn" onclick="setFilterType('ãƒãƒ£ãƒ³ã‚¹QR', this)">ãƒãƒ£ãƒ³ã‚¹</button>
        </div>

        <input type="text" id="searchInput" placeholder="æ¤œç´¢ (ã‚³ãƒ¼ãƒ‡åã€ãªã¾ãˆã€ãƒ–ãƒ©ãƒ³ãƒ‰ã€å¼¾æ•°)..." oninput="filterImages()">
    </div>

    <div id="gallery" class="gallery"></div>
    
    <button id="loadMoreBtn" onclick="showMoreImages()">ã‚‚ã£ã¨è¦‹ã‚‹ (+10æš)</button>

    <div id="imageModal" class="modal" onclick="closeModal()">
        <span class="modal-close">&times;</span>
        <img id="modalImg">
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // â–¼â–¼â–¼ ã‚ãªãŸã®ã‚­ãƒ¼æƒ…å ±ã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
        const firebaseConfig = {
          apiKey: "AIzaSyD0KuN_xxHp4p36s5jH3QVfpcpVaEWRUEA",
          authDomain: "aipri-qrinrin.firebaseapp.com",
          projectId: "aipri-qrinrin",
          storageBucket: "aipri-qrinrin.firebasestorage.app",
          messagingSenderId: "770009778959",
          appId: "1:770009778959:web:fdb1188463f5bfdecb8c7a",
          measurementId: "G-DQR6RGHTK7"
        };
        // â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²â–²

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let allImages = []; // å…¨ãƒ‡ãƒ¼ã‚¿
        let filteredImages = []; // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®ãƒ‡ãƒ¼ã‚¿
        let displayLimit = 5; // ç¾åœ¨è¡¨ç¤ºã™ã‚‹æšæ•°
        let currentTypeFilter = 'all'; // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ç¨®é¡ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

        // â– â–  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ â– â– 
        window.uploadImage = async () => {
            const file = document.getElementById('fileInput').files[0];
            const type = document.getElementById('typeSelect').value;
            const coordName = document.getElementById('coordName').value;
            const name = document.getElementById('nameSelect').value;
            const brand = document.getElementById('brandSelect').value;
            const series = document.getElementById('seriesSelect').value;

            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šã™ã¹ã¦å¿…é ˆ
            if (!file || !type || !coordName || !name || !brand || !series) {
                alert("å…¨é¸æŠè‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼");
                return;
            }

            document.getElementById('statusMsg').style.display = 'block';

            try {
                // 1. Storageã¸ä¿å­˜
                const storageRef = ref(storage, 'images/' + new Date().getTime() + '_' + file.name);
                await uploadBytes(storageRef, file);
                const url = await getDownloadURL(storageRef);

                // 2. Firestoreã¸ä¿å­˜
                await addDoc(collection(db, "coords"), {
                    imageUrl: url,
                    type: type,
                    coordName: coordName,
                    name: name,
                    brand: brand,
                    series: series,
                    createdAt: new Date()
                });

                alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
                location.reload(); 
            } catch (e) {
                console.error("Error:", e);
                alert("ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                document.getElementById('statusMsg').style.display = 'none';
            }
        };

        // â– â–  å‰Šé™¤æ©Ÿèƒ½ â– â– 
        window.deleteItem = async (id, imageUrl) => {
            if (!confirm("æœ¬å½“ã«ã“ã®ç”»åƒã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå…ƒã«æˆ»ã›ã¾ã›ã‚“ï¼‰")) return;

            // ç°¡æ˜“çš„ãªãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºï¼ˆãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’å¤‰ãˆã‚‹ï¼‰
            const btn = event.target;
            btn.innerText = "å‰Šé™¤ä¸­...";
            btn.disabled = true;

            try {
                await deleteDoc(doc(db, "coords", id));

                const imageRef = ref(storage, imageUrl);
                await deleteObject(imageRef).catch(e => {
                    console.warn("ç”»åƒå‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ã—ã¾ã™ï¼‰:", e);
                });

                alert("å‰Šé™¤ã—ã¾ã—ãŸ");
                location.reload();
            } catch (e) {
                console.error("å‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
                alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
                btn.innerText = "å‰Šé™¤";
                btn.disabled = false;
            }
        };

        // â– â–  èª­ã¿è¾¼ã¿æ©Ÿèƒ½ â– â– 
        async function loadImages() {
            try {
                const q = query(collection(db, "coords"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allImages = [];
                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    data.id = docSnap.id; 
                    allImages.push(data);
                });
                
                // åˆå›ãƒ•ã‚£ãƒ«ã‚¿å®Ÿè¡Œ
                filterImages();
            } catch (e) {
                console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", e);
            }
        }

        // â– â–  ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ â– â– 
        window.setFilterType = (type, btnElement) => {
            // çŠ¶æ…‹æ›´æ–°
            currentTypeFilter = type;

            // ãƒœã‚¿ãƒ³ã®è¦‹ãŸç›®æ›´æ–°
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btnElement.classList.add('active');

            // æ¤œç´¢å®Ÿè¡Œ
            displayLimit = 5; // ãƒ•ã‚£ãƒ«ã‚¿å¤‰æ›´æ™‚ã¯è¡¨ç¤ºæ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
            filterImages();
        };

        // â– â–  æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ­ã‚¸ãƒƒã‚¯ â– â– 
        window.filterImages = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            
            filteredImages = allImages.filter(item => {
                // 1. ç¨®é¡ãƒœã‚¿ãƒ³ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿
                let typeMatch = false;
                if (currentTypeFilter === 'all') {
                    typeMatch = true;
                } else {
                    typeMatch = (item.type === currentTypeFilter);
                }

                // 2. æ¤œç´¢ãƒãƒ¼ã«ã‚ˆã‚‹ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚£ãƒ«ã‚¿ï¼ˆç¨®é¡ã¯å«ã‚ãªã„ï¼‰
                // å¤ã„ãƒ‡ãƒ¼ã‚¿ã«brand/seriesãŒç„¡ã„å ´åˆã®å¯¾ç­–ã¨ã—ã¦ "|| ''" ã‚’è¿½åŠ 
                const textMatch = 
                    item.coordName.toLowerCase().includes(term) || 
                    item.name.includes(term) ||
                    (item.brand || '').includes(term) ||
                    (item.series || '').includes(term);

                return typeMatch && textMatch;
            });

            renderGallery();
        };

        // â– â–  æç”»æ©Ÿèƒ½ â– â– 
        function renderGallery() {
            const gallery = document.getElementById('gallery');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            gallery.innerHTML = "";

            const visibleItems = filteredImages.slice(0, displayLimit);

            visibleItems.forEach(item => {
                const card = document.createElement('div');
                card.className = "card";
                
                let imgSrc = item.imageUrl ? item.imageUrl : item.imageBase64;

                // è¡¨ç¤ºç”¨ã®ãƒ‡ãƒ¼ã‚¿æ•´å½¢ï¼ˆå¤ã„ãƒ‡ãƒ¼ã‚¿å¯¾ç­–ï¼‰
                const brandDisp = item.brand ? `ãƒ–ãƒ©ãƒ³ãƒ‰: ${item.brand}<br>` : "";
                const seriesDisp = item.series ? `å¼¾æ•°: ${item.series}<br>` : "";

                card.innerHTML = `
                    <div class="img-container" onclick="openModal('${imgSrc}')">
                        <img src="${imgSrc}" loading="lazy" alt="${item.coordName}">
                    </div>
                    <div class="tags">
                        <span class="coord-title">${item.coordName}</span>
                        ãªã¾ãˆ: ${item.name}<br>
                        ç¨®é¡: ${item.type}<br>
                        ${brandDisp}
                        ${seriesDisp}
                    </div>
                    <button class="btn-delete" onclick="deleteItem('${item.id}', '${imgSrc}')">å‰Šé™¤</button>
                `;
                gallery.appendChild(card);
            });

            if (filteredImages.length > displayLimit) {
                loadMoreBtn.style.display = "block";
                loadMoreBtn.innerText = `ã‚‚ã£ã¨è¦‹ã‚‹ (æ®‹ã‚Š ${filteredImages.length - displayLimit}æš)`;
            } else {
                loadMoreBtn.style.display = "none";
            }
        }

        window.showMoreImages = () => {
            displayLimit += 10;
            renderGallery();
        };

        // â– â–  ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ â– â– 
        window.openModal = (src) => {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImg');
            modal.style.display = "flex";
            modalImg.src = src;
        };

        window.closeModal = () => {
            document.getElementById('imageModal').style.display = "none";
        };

        loadImages();
    </script>
</body>
</html>

